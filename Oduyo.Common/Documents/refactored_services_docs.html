<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ†• Yeni Servisler - V2.0 Refactor DokÃ¼mantasyonu</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .version-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 0.5rem;
        }

        nav {
            background: #2c3e50;
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        nav ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        nav a {
            color: white;
            text-decoration: none;
            transition: color 0.3s;
        }

        nav a:hover {
            color: #3498db;
        }

        main {
            padding: 2rem;
        }

        section {
            margin-bottom: 3rem;
        }

        h2 {
            color: #667eea;
            font-size: 1.8rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid #667eea;
        }

        h3 {
            color: #764ba2;
            font-size: 1.4rem;
            margin: 1.5rem 0 1rem;
        }

        h4 {
            color: #555;
            font-size: 1.1rem;
            margin: 1rem 0 0.5rem;
        }

        pre {
            background: #282c34;
            color: #abb2bf;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            border-left: 4px solid #667eea;
        }

        code {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .keyword { color: #c678dd; }
        .string { color: #98c379; }
        .comment { color: #5c6370; font-style: italic; }
        .method { color: #61afef; }
        .type { color: #e5c07b; }
        .number { color: #d19a66; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        th {
            background: #667eea;
            color: white;
            padding: 1rem;
            text-align: left;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .note {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .new-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
        }

        li {
            margin: 0.5rem 0;
        }

        footer {
            background: #2c3e50;
            color: white;
            text-align: center;
            padding: 1.5rem;
            margin-top: 3rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ†• V2.0 Refactor - Yeni Servisler ve Ã–zellikler</h1>
            <p>Phase 5 ile Eklenen Yeni Servisler ve GÃ¼ncellemeler</p>
            <span class="version-badge">v2.0-refactor</span>
        </header>

        <nav>
            <ul>
                <li><a href="#overview">Genel BakÄ±ÅŸ</a></li>
                <li><a href="#license-updates">License GÃ¼ncellemeleri</a></li>
                <li><a href="#credit-usage">Credit Usage</a></li>
                <li><a href="#dealer-commission">Dealer Commission</a></li>
                <li><a href="#offer-pricing">Offer Pricing</a></li>
                <li><a href="#offer-updates">Offer GÃ¼ncellemeleri</a></li>
                <li><a href="#payment-updates">Payment GÃ¼ncellemeleri</a></li>
            </ul>
        </nav>

        <main>
            <section id="overview">
                <h2>ğŸ“‹ Genel BakÄ±ÅŸ</h2>

                <div class="note">
                    <strong>ğŸ’¡ V2.0 Refactor:</strong> Bu dokÃ¼mantasyon Phase 5 ile eklenen yeni servisleri ve mevcut servislere eklenen yeni Ã¶zellikleri iÃ§erir.
                </div>

                <h3>Yeni Servisler</h3>
                <ul>
                    <li><strong>CreditUsageService:</strong> FIFO kredi yÃ¶netimi ve kullanÄ±m takibi</li>
                    <li><strong>DealerCommissionService:</strong> Bayi komisyon hesaplama ve Ã¶deme yÃ¶netimi</li>
                    <li><strong>OfferPricingService:</strong> GeliÅŸmiÅŸ fiyatlandÄ±rma ve kampanya yÃ¶netimi</li>
                </ul>

                <h3>GÃ¼ncellenen Servisler</h3>
                <ul>
                    <li><strong>LicenseService:</strong> Grace period, trial lisans, master lisans senkronizasyonu</li>
                    <li><strong>OfferService:</strong> OTP doÄŸrulama, kampanya freeze period</li>
                    <li><strong>PaymentService:</strong> GeliÅŸmiÅŸ hata yÃ¶netimi, provider transaction tracking</li>
                </ul>

                <h3>Yeni Teknolojiler</h3>
                <ul>
                    <li><strong>MassTransit:</strong> Asenkron mesajlaÅŸma (SMS, Email, PDF, Calendar)</li>
                    <li><strong>Hangfire:</strong> Background jobs (Lisans kontrolÃ¼, teklif hatÄ±rlatma, kredi takibi)</li>
                </ul>
            </section>

            <section id="license-updates">
                <h2>ğŸ” LicenseService GÃ¼ncellemeleri <span class="new-badge">UPDATED</span></h2>

                <h3>1. Grace Period DesteÄŸi</h3>
                <div class="success">
                    <strong>âœ“ Yeni Ã–zellik:</strong> Lisans sÃ¼resi dolduktan sonra 7 gÃ¼nlÃ¼k kullanÄ±m sÃ¼resi
                </div>

                <pre><code><span class="comment">// Grace period ile lisans doÄŸrulama</span>
<span class="keyword">var</span> result = <span class="keyword">await</span> _licenseService.ValidateLicenseAsync(licenseId);

<span class="keyword">if</span> (result.IsValid)
{
    <span class="keyword">if</span> (result.IsInGracePeriod)
    {
        Console.WriteLine(<span class="string">$"UyarÄ±: Grace period iÃ§indesiniz. {result.DaysRemaining} gÃ¼n kaldÄ±"</span>);
    }
    <span class="comment">// Lisans geÃ§erli, iÅŸleme devam et</span>
}
<span class="keyword">else</span>
{
    Console.WriteLine(<span class="string">$"Lisans geÃ§ersiz: {result.Reason}"</span>);
}</code></pre>

                <h3>2. Trial Lisans OluÅŸturma</h3>
                <pre><code><span class="comment">// 30 gÃ¼nlÃ¼k deneme lisansÄ±</span>
<span class="keyword">var</span> trialLicense = <span class="keyword">await</span> _licenseService.CreateTrialLicenseAsync(
    companyId: <span class="number">10</span>,
    productId: <span class="number">1</span>,
    packageId: <span class="number">2</span>,
    trialDays: <span class="number">30</span>,
    createdBy: currentUserId
);

<span class="comment">// Otomatik email gÃ¶nderilir: "Deneme lisansÄ±nÄ±z aktif"</span></code></pre>

                <h3>3. Master Lisans Senkronizasyonu</h3>
                <div class="note">
                    <strong>ğŸ’¡ KullanÄ±m Senaryosu:</strong> MÃ¼ÅŸteri yeni paket alÄ±rken, mevcut lisanslarÄ±yla aynÄ± bitiÅŸ tarihine sahip olmalÄ±.
                </div>

                <pre><code><span class="comment">// Yeni paket eklerken bitiÅŸ tarihini senkronize et</span>
<span class="keyword">var</span> newLicense = <span class="keyword">await</span> _licenseService.SynchronizeLicenseEndDateAsync(
    companyId: <span class="number">10</span>,
    productId: <span class="number">2</span>,
    packageId: <span class="number">5</span>,
    createdBy: currentUserId
);

<span class="comment">// Yeni lisans, firmanÄ±n master lisansÄ± ile aynÄ± EndDate'e sahip olur</span></code></pre>

                <h3>Yeni Entity AlanlarÄ±</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Alan</th>
                            <th>Tip</th>
                            <th>AÃ§Ä±klama</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>IsTrial</td>
                            <td>bool</td>
                            <td>Deneme lisansÄ± mÄ±? (IsTrialPeriod yerine)</td>
                        </tr>
                        <tr>
                            <td>TrialDays</td>
                            <td>int?</td>
                            <td>Deneme sÃ¼resi (gÃ¼n)</td>
                        </tr>
                        <tr>
                            <td>GracePeriodDays</td>
                            <td>int</td>
                            <td>Grace period sÃ¼resi (default: 7)</td>
                        </tr>
                        <tr>
                            <td>GracePeriodStartDate</td>
                            <td>DateTime?</td>
                            <td>Grace period baÅŸlangÄ±Ã§ tarihi</td>
                        </tr>
                    </tbody>
                </table>

                <div class="warning">
                    <strong>âš ï¸ Breaking Change:</strong> <code>IsTrialPeriod</code> â†’ <code>IsTrial</code> olarak deÄŸiÅŸtirildi.
                </div>
            </section>

            <section id="credit-usage">
                <h2>ğŸ’³ CreditUsageService <span class="new-badge">NEW</span></h2>

                <div class="note">
                    <strong>ğŸ’¡ Ne Ä°ÅŸe Yarar?</strong> MÃ¼ÅŸteri kredilerinin FIFO (First In First Out) mantÄ±ÄŸÄ±yla tÃ¼ketilmesini ve takibini saÄŸlar.
                </div>

                <h3>FIFO Kredi TÃ¼ketimi</h3>
                <pre><code><span class="comment">// 100 birim kredi tÃ¼ket (en eski krediden baÅŸlayarak)</span>
<span class="keyword">var</span> success = <span class="keyword">await</span> _creditUsageService.ConsumeCreditsAsync(
    companyId: <span class="number">10</span>,
    amount: <span class="number">100</span>,
    description: <span class="string">"100 SMS gÃ¶nderimi"</span>
);

<span class="keyword">if</span> (!success)
{
    <span class="keyword">return</span> BadRequest(<span class="string">"Yetersiz kredi"</span>);
}

<span class="comment">// Low credit warning otomatik gÃ¶nderilir (< 100 kalan)</span></code></pre>

                <h3>Kredi KontrolÃ¼</h3>
                <pre><code><span class="comment">// Ä°ÅŸlem Ã¶ncesi kredi kontrolÃ¼</span>
<span class="keyword">var</span> hasSufficientCredit = <span class="keyword">await</span> _creditUsageService.HasSufficientCreditsAsync(
    companyId: <span class="number">10</span>,
    required: <span class="number">500</span>
);

<span class="keyword">if</span> (!hasSufficientCredit)
{
    <span class="keyword">throw new</span> InsufficientCreditException(<span class="string">"Yetersiz kredi bakiyesi"</span>);
}</code></pre>

                <h3>Kredi Ã–zeti</h3>
                <pre><code><span class="comment">// Firma kredi durumu Ã¶zeti</span>
<span class="keyword">var</span> summary = <span class="keyword">await</span> _creditUsageService.GetCreditUsageSummaryAsync(companyId);

Console.WriteLine(<span class="string">$"Toplam Kredi: {summary.TotalCredits}"</span>);
Console.WriteLine(<span class="string">$"KullanÄ±lan: {summary.UsedCredits}"</span>);
Console.WriteLine(<span class="string">$"Kalan: {summary.RemainingCredits}"</span>);
Console.WriteLine(<span class="string">$"SÃ¼resi DolmuÅŸ: {summary.ExpiredCredits}"</span>);</code></pre>

                <h3>KullanÄ±m GeÃ§miÅŸi</h3>
                <pre><code><span class="comment">// Son 30 gÃ¼nÃ¼n kredi kullanÄ±m geÃ§miÅŸi</span>
<span class="keyword">var</span> history = <span class="keyword">await</span> _creditUsageService.GetCreditUsageHistoryAsync(
    companyId: <span class="number">10</span>,
    from: DateTime.UtcNow.AddDays(-<span class="number">30</span>),
    to: DateTime.UtcNow
);

<span class="keyword">foreach</span> (<span class="keyword">var</span> usage <span class="keyword">in</span> history)
{
    Console.WriteLine(<span class="string">$"{usage.UsedAt:dd.MM.yyyy} - {usage.Amount} kredi - {usage.Description}"</span>);
}</code></pre>

                <h3>Yeni Entity: CreditUsage</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Alan</th>
                            <th>Tip</th>
                            <th>AÃ§Ä±klama</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>CreditId</td>
                            <td>int</td>
                            <td>Hangi kredi paketinden kullanÄ±ldÄ±</td>
                        </tr>
                        <tr>
                            <td>CompanyId</td>
                            <td>int</td>
                            <td>Firma ID</td>
                        </tr>
                        <tr>
                            <td>Amount</td>
                            <td>int</td>
                            <td>KullanÄ±lan miktar</td>
                        </tr>
                        <tr>
                            <td>Description</td>
                            <td>string</td>
                            <td>Ne iÃ§in kullanÄ±ldÄ±</td>
                        </tr>
                        <tr>
                            <td>UsedAt</td>
                            <td>DateTime</td>
                            <td>KullanÄ±m zamanÄ±</td>
                        </tr>
                    </tbody>
                </table>

                <div class="success">
                    <strong>âœ“ Otomatik Ã–zellikler:</strong>
                    <ul>
                        <li>FIFO mantÄ±ÄŸÄ±yla en eski krediden tÃ¼ketir</li>
                        <li>Kredi < 100 olunca otomatik email uyarÄ±sÄ±</li>
                        <li>SÃ¼resi dolmuÅŸ krediler kullanÄ±lamaz</li>
                        <li>TÃ¼m iÅŸlemler MassTransit ile asenkron</li>
                    </ul>
                </div>
            </section>

            <section id="dealer-commission">
                <h2>ğŸ’¼ DealerCommissionService <span class="new-badge">NEW</span></h2>

                <div class="note">
                    <strong>ğŸ’¡ Ne Ä°ÅŸe Yarar?</strong> Bayi komisyonlarÄ±nÄ±n otomatik hesaplanmasÄ±, onaylanmasÄ± ve Ã¶deme takibi.
                </div>

                <h3>Komisyon OluÅŸturma</h3>
                <pre><code><span class="comment">// Ã–deme tamamlandÄ±ktan sonra otomatik komisyon oluÅŸtur</span>
<span class="keyword">var</span> commission = <span class="keyword">await</span> _dealerCommissionService.CreateCommissionAsync(
    <span class="keyword">new</span> CreateDealerCommissionDto
    {
        DealerId = <span class="number">5</span>,
        CompanyId = <span class="number">10</span>,
        OfferId = <span class="number">123</span>,
        PaymentId = <span class="number">456</span>,
        BaseAmount = <span class="number">10000</span>, <span class="comment">// Ã–deme tutarÄ±</span>
        CommissionRate = <span class="number">15</span>, <span class="comment">// %15 komisyon</span>
        Notes = <span class="string">"Teklif #123 iÃ§in komisyon"</span>
    },
    createdBy: currentUserId
);

<span class="comment">// CommissionAmount otomatik hesaplanÄ±r: 10000 * 0.15 = 1500</span></code></pre>

                <h3>Komisyon Onaylama</h3>
                <pre><code><span class="comment">// Komisyonu onayla</span>
<span class="keyword">var</span> approved = <span class="keyword">await</span> _dealerCommissionService.ApproveCommissionAsync(
    commissionId: <span class="number">789</span>,
    approvedBy: managerUserId
);

<span class="comment">// Otomatik email: "Hak ediÅŸ onaylandÄ±"</span></code></pre>

                <h3>Komisyon Ã–deme</h3>
                <pre><code><span class="comment">// Komisyonu Ã¶denmiÅŸ iÅŸaretle</span>
<span class="keyword">var</span> paid = <span class="keyword">await</span> _dealerCommissionService.PayCommissionAsync(
    commissionId: <span class="number">789</span>,
    paidBy: financeUserId
);

<span class="comment">// Otomatik email: "Hak ediÅŸ Ã¶dendi - Tarih: dd.MM.yyyy"</span></code></pre>

                <h3>Bayi Komisyon Raporu</h3>
                <pre><code><span class="comment">// Bayinin toplam komisyon raporu</span>
<span class="keyword">var</span> report = <span class="keyword">await</span> _dealerCommissionService.GetDealerReportAsync(
    dealerId: <span class="number">5</span>,
    from: DateTime.UtcNow.AddMonths(-<span class="number">1</span>)
);

Console.WriteLine(<span class="string">$"Toplam Komisyon: {report.TotalCommissionAmount:C}"</span>);
Console.WriteLine(<span class="string">$"Bekleyen: {report.PendingAmount:C}"</span>);
Console.WriteLine(<span class="string">$"Onaylanan: {report.ApprovedAmount:C}"</span>);
Console.WriteLine(<span class="string">$"Ã–denen: {report.PaidAmount:C}"</span>);
Console.WriteLine(<span class="string">$"Ä°ÅŸlem SayÄ±sÄ±: {report.CommissionCount}"</span>);</code></pre>

                <h3>Yeni Entity: DealerCommission</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Alan</th>
                            <th>Tip</th>
                            <th>AÃ§Ä±klama</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>DealerId</td>
                            <td>int</td>
                            <td>Bayi ID</td>
                        </tr>
                        <tr>
                            <td>CompanyId</td>
                            <td>int</td>
                            <td>MÃ¼ÅŸteri firma ID</td>
                        </tr>
                        <tr>
                            <td>OfferId</td>
                            <td>int?</td>
                            <td>Ä°lgili teklif</td>
                        </tr>
                        <tr>
                            <td>PaymentId</td>
                            <td>int?</td>
                            <td>Ä°lgili Ã¶deme</td>
                        </tr>
                        <tr>
                            <td>BaseAmount</td>
                            <td>decimal</td>
                            <td>Ana tutar (Ã¶deme)</td>
                        </tr>
                        <tr>
                            <td>CommissionRate</td>
                            <td>decimal</td>
                            <td>Komisyon oranÄ± (%)</td>
                        </tr>
                        <tr>
                            <td>CommissionAmount</td>
                            <td>decimal</td>
                            <td>Komisyon tutarÄ± (otomatik hesaplanan)</td>
                        </tr>
                        <tr>
                            <td>Status</td>
                            <td>enum</td>
                            <td>Pending, Approved, Paid, Cancelled</td>
                        </tr>
                        <tr>
                            <td>PaidAt</td>
                            <td>DateTime?</td>
                            <td>Ã–deme tarihi</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Komisyon DurumlarÄ± (CommissionStatus)</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Durum</th>
                            <th>AÃ§Ä±klama</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Pending</td>
                            <td>Beklemede - OluÅŸturuldu, onay bekliyor</td>
                        </tr>
                        <tr>
                            <td>Approved</td>
                            <td>OnaylandÄ± - Ã–deme yapÄ±labilir</td>
                        </tr>
                        <tr>
                            <td>Paid</td>
                            <td>Ã–dendi - Bayi Ã¶demesi yapÄ±ldÄ±</td>
                        </tr>
                        <tr>
                            <td>Cancelled</td>
                            <td>Ä°ptal - Ä°ade vs. nedeniyle iptal</td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <section id="offer-pricing">
                <h2>ğŸ’° OfferPricingService <span class="new-badge">NEW</span></h2>

                <div class="note">
                    <strong>ğŸ’¡ Ne Ä°ÅŸe Yarar?</strong> Teklif fiyatlandÄ±rmasÄ±nÄ± kampanya, manuel indirim ve Ã§apraz satÄ±ÅŸ kurallarÄ±yla hesaplar.
                </div>

                <h3>Fiyat Hesaplama</h3>
                <pre><code><span class="comment">// Teklif fiyatÄ±nÄ± hesapla</span>
<span class="keyword">var</span> pricing = <span class="keyword">await</span> _offerPricingService.CalculatePricingAsync(
    <span class="keyword">new</span> OfferPricingRequest
    {
        Details = <span class="keyword">new</span>[]
        {
            <span class="keyword">new</span> OfferDetailDto { PackageId = <span class="number">1</span>, Quantity = <span class="number">1</span>, UnitPrice = <span class="number">5000</span> },
            <span class="keyword">new</span> OfferDetailDto { ModuleId = <span class="number">3</span>, Quantity = <span class="number">2</span>, UnitPrice = <span class="number">1500</span> }
        },
        CampaignId = <span class="number">10</span>,
        ManualDiscountRate = <span class="number">5</span>, <span class="comment">// %5 manuel indirim</span>
        UserId = currentUserId
    }
);

Console.WriteLine(<span class="string">$"Alt Toplam: {pricing.SubTotal:C}"</span>);
Console.WriteLine(<span class="string">$"Kampanya Ä°ndirimi: -{pricing.CampaignDiscount:C}"</span>);
Console.WriteLine(<span class="string">$"Ã‡apraz SatÄ±ÅŸ Ä°ndirimi: -{pricing.CrossSellDiscount:C}"</span>);
Console.WriteLine(<span class="string">$"Manuel Ä°ndirim: -{pricing.ManualDiscount:C}"</span>);
Console.WriteLine(<span class="string">$"<strong>Toplam: {pricing.FinalPrice:C}</strong>"</span>);</code></pre>

                <h3>Kampanya Freeze Period</h3>
                <div class="warning">
                    <strong>âš ï¸ Ã–nemli:</strong> Kampanya bitiÅŸ tarihinden 7 gÃ¼n Ã¶ncesi "freeze period"dur. Bu sÃ¼rede kampanya deÄŸiÅŸtirilemez ama uygulanmaya devam eder.
                </div>

                <pre><code><span class="keyword">if</span> (pricing.IsCampaignFrozen)
{
    Console.WriteLine(<span class="string">"Kampanya freeze period iÃ§inde - deÄŸiÅŸtirilemez"</span>);
}

<span class="keyword">if</span> (pricing.IsCampaignActive)
{
    Console.WriteLine(<span class="string">"Kampanya aktif ve uygulandÄ±"</span>);
}</code></pre>

                <h3>Manuel Ä°ndirim Yetki KontrolÃ¼</h3>
                <pre><code><span class="comment">// KullanÄ±cÄ±nÄ±n indirim yetkisi otomatik kontrol edilir</span>
<span class="keyword">try</span>
{
    <span class="keyword">var</span> pricing = <span class="keyword">await</span> _offerPricingService.CalculatePricingAsync(request);
}
<span class="keyword">catch</span> (UnauthorizedAccessException ex)
{
    <span class="comment">// KullanÄ±cÄ±nÄ±n %X indirim yetkisi yok</span>
    Console.WriteLine(ex.Message);
}</code></pre>

                <h3>Ã‡apraz SatÄ±ÅŸ Perkleri</h3>
                <div class="success">
                    <strong>âœ“ Otomatik Kurallar:</strong>
                    <ul>
                        <li>Enterprise Tahsilat paketi â†’ Ekstre Lite modÃ¼lÃ¼ bedava</li>
                        <li>Daha fazla kural eklenebilir</li>
                    </ul>
                </div>

                <pre><code><span class="comment">// Cross-sell perkleri otomatik uygulanÄ±r</span>
<span class="keyword">var</span> crossSell = <span class="keyword">await</span> _offerPricingService.CalculateCrossSellPerksAsync(details);
Console.WriteLine(<span class="string">$"Ã‡apraz SatÄ±ÅŸ Ä°ndirimi: {crossSell:C}"</span>);</code></pre>

                <h3>OfferPriceCalculation Model</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Alan</th>
                            <th>AÃ§Ä±klama</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>SubTotal</td>
                            <td>Alt toplam (indirim Ã¶ncesi)</td>
                        </tr>
                        <tr>
                            <td>CampaignDiscount</td>
                            <td>Kampanya indirimi</td>
                        </tr>
                        <tr>
                            <td>CrossSellDiscount</td>
                            <td>Ã‡apraz satÄ±ÅŸ indirimi</td>
                        </tr>
                        <tr>
                            <td>ManualDiscount</td>
                            <td>Manuel indirim (yetki kontrolÃ¼ ile)</td>
                        </tr>
                        <tr>
                            <td>FinalPrice</td>
                            <td>Nihai fiyat</td>
                        </tr>
                        <tr>
                            <td>IsCampaignActive</td>
                            <td>Kampanya aktif mi?</td>
                        </tr>
                        <tr>
                            <td>IsCampaignFrozen</td>
                            <td>Freeze period iÃ§inde mi?</td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <section id="offer-updates">
                <h2>ğŸ’° Offer Entity GÃ¼ncellemeleri <span class="new-badge">UPDATED</span></h2>

                <h3>1. FiyatlandÄ±rma Breakdown</h3>
                <div class="note">
                    <strong>ğŸ’¡ DeÄŸiÅŸiklik:</strong> Tek bir <code>Total</code> yerine detaylÄ± fiyat ayrÄ±mÄ±
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Eski</th>
                            <th>Yeni</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>SubTotal</td>
                            <td>SubTotal (aynÄ±)</td>
                        </tr>
                        <tr>
                            <td>DiscountAmount</td>
                            <td>âŒ KaldÄ±rÄ±ldÄ±</td>
                        </tr>
                        <tr>
                            <td>DiscountRate</td>
                            <td>âŒ KaldÄ±rÄ±ldÄ±</td>
                        </tr>
                        <tr>
                            <td>Total</td>
                            <td>âŒ KaldÄ±rÄ±ldÄ±</td>
                        </tr>
                        <tr>
                            <td>-</td>
                            <td>âœ… CampaignDiscount</td>
                        </tr>
                        <tr>
                            <td>-</td>
                            <td>âœ… ManualDiscount</td>
                        </tr>
                        <tr>
                            <td>-</td>
                            <td>âœ… ManualDiscountRate</td>
                        </tr>
                        <tr>
                            <td>-</td>
                            <td>âœ… TotalAmount</td>
                        </tr>
                    </tbody>
                </table>

                <h3>2. Kampanya DesteÄŸi</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Alan</th>
                            <th>Tip</th>
                            <th>AÃ§Ä±klama</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>CampaignId</td>
                            <td>int?</td>
                            <td>Uygulanan kampanya</td>
                        </tr>
                        <tr>
                            <td>IsCampaignLocked</td>
                            <td>bool</td>
                            <td>Freeze period kilidi (7 gÃ¼n)</td>
                        </tr>
                    </tbody>
                </table>

                <h3>3. OTP DoÄŸrulama</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Alan</th>
                            <th>Tip</th>
                            <th>AÃ§Ä±klama</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>OtpCodeHash</td>
                            <td>string</td>
                            <td>Hash'lenmiÅŸ OTP kodu</td>
                        </tr>
                        <tr>
                            <td>OtpSentAt</td>
                            <td>DateTime?</td>
                            <td>OTP gÃ¶nderim zamanÄ±</td>
                        </tr>
                        <tr>
                            <td>OtpVerifiedAt</td>
                            <td>DateTime?</td>
                            <td>OTP doÄŸrulama zamanÄ±</td>
                        </tr>
                        <tr>
                            <td>IsOtpVerified</td>
                            <td>bool</td>
                            <td>OTP doÄŸrulandÄ± mÄ±?</td>
                        </tr>
                    </tbody>
                </table>

                <h3>OTP KullanÄ±mÄ±</h3>
                <pre><code><span class="comment">// 1. Teklif gÃ¶nderirken OTP oluÅŸtur ve SMS ile gÃ¶nder</span>
<span class="keyword">var</span> otpSent = <span class="keyword">await</span> _offerService.SendOfferOtpAsync(offerId);

<span class="comment">// 2. MÃ¼ÅŸteri OTP ile doÄŸrula</span>
<span class="keyword">var</span> verified = <span class="keyword">await</span> _offerService.VerifyOfferOtpAsync(
    offerId,
    otpCode: <span class="string">"123456"</span>
);

<span class="keyword">if</span> (verified)
{
    <span class="comment">// Teklif kabul edilebilir</span>
}</code></pre>
            </section>

            <section id="payment-updates">
                <h2>ğŸ’³ Payment Entity GÃ¼ncellemeleri <span class="new-badge">UPDATED</span></h2>

                <h3>Yeni Alanlar</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Alan</th>
                            <th>Tip</th>
                            <th>AÃ§Ä±klama</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>ProviderTransactionId</td>
                            <td>string</td>
                            <td>Sanal POS provider'dan gelen TXN ID</td>
                        </tr>
                        <tr>
                            <td>PaymentDate</td>
                            <td>DateTime</td>
                            <td>Ã–deme baÅŸlatma tarihi</td>
                        </tr>
                        <tr>
                            <td>CompletedAt</td>
                            <td>DateTime?</td>
                            <td>Ã–deme tamamlanma zamanÄ±</td>
                        </tr>
                        <tr>
                            <td>FailureReason</td>
                            <td>string</td>
                            <td>BaÅŸarÄ±sÄ±zlÄ±k nedeni</td>
                        </tr>
                        <tr>
                            <td>FailureCode</td>
                            <td>string</td>
                            <td>Hata kodu (provider'dan)</td>
                        </tr>
                    </tbody>
                </table>

                <h3>GeliÅŸmiÅŸ Hata YÃ¶netimi</h3>
                <pre><code><span class="comment">// Ã–deme baÅŸarÄ±sÄ±z olduÄŸunda detaylÄ± hata kaydet</span>
<span class="keyword">await</span> _paymentService.FailPaymentAsync(
    paymentId,
    failureReason: <span class="string">"Yetersiz bakiye"</span>,
    failureCode: <span class="string">"INSUFFICIENT_FUNDS"</span>
);

<span class="comment">// Payment.FailureReason ve FailureCode kaydedilir</span></code></pre>

                <h3>Provider Transaction Tracking</h3>
                <pre><code><span class="comment">// Ã–deme tamamlandÄ±ÄŸÄ±nda provider TXN ID'yi kaydet</span>
<span class="keyword">await</span> _paymentService.CompletePaymentAsync(
    paymentId,
    providerTxnId: <span class="string">"IBANK_TXN_987654321"</span>,
    completedBy: currentUserId
);

<span class="comment">// Daha sonra provider TXN ile Ã¶deme sorgulanabilir</span></code></pre>
            </section>

            <section>
                <h2>ğŸ”„ MassTransit Entegrasyonu</h2>

                <div class="success">
                    <strong>âœ“ Asenkron Ä°ÅŸlemler:</strong> TÃ¼m email, SMS, PDF ve calendar iÅŸlemleri artÄ±k asenkron yapÄ±lÄ±yor.
                </div>

                <h3>Otomatik Tetiklenen Ä°ÅŸlemler</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Olay</th>
                            <th>Mesaj</th>
                            <th>SonuÃ§</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Trial Lisans OluÅŸturma</td>
                            <td>SendEmailMessage</td>
                            <td>Email: "Deneme lisansÄ±nÄ±z aktif"</td>
                        </tr>
                        <tr>
                            <td>Kredi < 100</td>
                            <td>SendEmailMessage</td>
                            <td>Email: "Kredi azaldÄ±"</td>
                        </tr>
                        <tr>
                            <td>Komisyon OnaylandÄ±</td>
                            <td>SendEmailMessage</td>
                            <td>Email: "Hak ediÅŸ onaylandÄ±"</td>
                        </tr>
                        <tr>
                            <td>Komisyon Ã–dendi</td>
                            <td>SendEmailMessage</td>
                            <td>Email: "Hak ediÅŸ Ã¶dendi"</td>
                        </tr>
                        <tr>
                            <td>Teklif PDF Ä°steÄŸi</td>
                            <td>GenerateOfferPdfMessage</td>
                            <td>PDF oluÅŸtur ve email ekinde gÃ¶nder</td>
                        </tr>
                        <tr>
                            <td>Demo OluÅŸturma</td>
                            <td>SyncCalendarMessage</td>
                            <td>Google Calendar'a ekle</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Message Ã–rnekleri</h3>
                <pre><code><span class="comment">// Email gÃ¶nderme (template ile)</span>
<span class="keyword">await</span> _bus.Publish(<span class="keyword">new</span> SendEmailMessage
{
    To = <span class="string">"user@example.com"</span>,
    Subject = <span class="string">"LisansÄ±nÄ±z Dolmak Ãœzere"</span>,
    TemplateId = <span class="string">"license-expiring"</span>,
    TemplateData = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;
    {
        [<span class="string">"DaysRemaining"</span>] = <span class="string">"7"</span>
    }
});

<span class="comment">// SMS gÃ¶nderme</span>
<span class="keyword">await</span> _bus.Publish(<span class="keyword">new</span> SendSmsMessage
{
    Phone = <span class="string">"5551234567"</span>,
    Message = <span class="string">"Teklif OTP kodunuz: 123456"</span>,
    EntityType = <span class="string">"Offer"</span>,
    RelatedEntityId = offerId
});</code></pre>
            </section>

            <section>
                <h2>â° Hangfire Background Jobs</h2>

                <h3>ZamanlanmÄ±ÅŸ Job'lar</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Job</th>
                            <th>Ã‡alÄ±ÅŸma SÄ±klÄ±ÄŸÄ±</th>
                            <th>GÃ¶rev</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>OfferExpiryJob</td>
                            <td>Saatlik</td>
                            <td>SÃ¼resi dolan teklifleri Expired durumuna alÄ±r</td>
                        </tr>
                        <tr>
                            <td>OfferReminderJob</td>
                            <td>GÃ¼nlÃ¼k 09:00</td>
                            <td>5 gÃ¼n iÃ§inde dolacak teklifler iÃ§in hatÄ±rlatma</td>
                        </tr>
                        <tr>
                            <td>LicenseMonitorJob</td>
                            <td>GÃ¼nlÃ¼k 02:00</td>
                            <td>Grace period aktivasyon, sÃ¼resi dolan lisanslarÄ± deaktive et</td>
                        </tr>
                        <tr>
                            <td>CreditExpiryJob</td>
                            <td>GÃ¼nlÃ¼k 03:00</td>
                            <td>SÃ¼resi dolan krediler iÃ§in bildirim, 7 gÃ¼n Ã¶nceden uyarÄ±</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Dashboard</h3>
                <pre><code><span class="comment">// Hangfire Dashboard</span>
<span class="comment">// URL: https://yourdomain.com/hangfire</span>

<span class="comment">// Recurring Jobs sekmesinde tÃ¼m job'larÄ± gÃ¶rebilirsiniz</span>
<span class="comment">// "Trigger Now" ile manuel tetikleyebilirsiniz</span></code></pre>
            </section>

            <section>
                <h2>ğŸ“¦ Migration Checklist</h2>

                <div class="warning">
                    <strong>âš ï¸ Ã–nemli:</strong> Production'a geÃ§meden Ã¶nce tÃ¼m adÄ±mlarÄ± tamamlayÄ±n!
                </div>

                <h3>Database DeÄŸiÅŸiklikleri</h3>
                <ul>
                    <li>âœ… License: IsTrial, TrialDays, GracePeriodDays, GracePeriodStartDate</li>
                    <li>âœ… Offer: CampaignDiscount, ManualDiscount, TotalAmount, CampaignId, IsCampaignLocked, OTP alanlarÄ±</li>
                    <li>âœ… Payment: ProviderTransactionId, PaymentDate, CompletedAt, FailureReason, FailureCode</li>
                    <li>âœ… Company: ContactName, Phone, Email, Address, ProductInterests</li>
                    <li>âœ… Demo: DemoEndTime, ReferenceCode, ChannelId, LocationType, CalendarEventId</li>
                    <li>âœ… Campaign: IsPublic, computed properties (IsCurrentlyActive, IsWithinFreezePeriod)</li>
                    <li>âœ… YENÄ°: DealerCommission tablosu</li>
                    <li>âœ… YENÄ°: DiscountRate tablosu</li>
                    <li>âœ… YENÄ°: CreditUsage tablosu</li>
                </ul>

                <h3>Servis KayÄ±tlarÄ± (Program.cs)</h3>
                <pre><code><span class="comment">// Yeni servisler</span>
builder.Services.AddScoped&lt;ICreditUsageService, CreditUsageService&gt;();
builder.Services.AddScoped&lt;IDealerCommissionService, DealerCommissionService&gt;();
builder.Services.AddScoped&lt;IOfferPricingService, OfferPricingService&gt;();

<span class="comment">// MassTransit</span>
builder.Services.AddMassTransit(x => { <span class="comment">/* config */</span> });

<span class="comment">// Hangfire</span>
builder.Services.AddHangfire(config => { <span class="comment">/* config */</span> });
builder.Services.AddHangfireServer();</code></pre>
            </section>

            <section>
                <h2>ğŸ“š Kaynaklar</h2>

                <ul>
                    <li><strong>REFACTOR_SUMMARY.md</strong> - TÃ¼m deÄŸiÅŸikliklerin Ã¶zeti</li>
                    <li><strong>PHASE_6_IMPLEMENTATION_GUIDE.md</strong> - AdÄ±m adÄ±m uygulama kÄ±lavuzu</li>
                    <li><strong>oduyo_refactor_plan_rev1.md</strong> - Orijinal refactor planÄ±</li>
                </ul>

                <div class="note">
                    <strong>ğŸ’¡ SorularÄ±nÄ±z iÃ§in:</strong> PHASE_6_IMPLEMENTATION_GUIDE.md dosyasÄ±na bakÄ±n veya teknik liderle gÃ¶rÃ¼ÅŸÃ¼n.
                </div>
            </section>
        </main>

        <footer>
            <p>&copy; 2025 Ã–dÃ¼yo CRM - V2.0 Refactor DokÃ¼mantasyonu</p>
            <p><strong>Versiyon:</strong> 2.0-refactor | <strong>GÃ¼ncelleme Tarihi:</strong> 2025-10-08</p>
        </footer>
    </div>
</body>
</html>
