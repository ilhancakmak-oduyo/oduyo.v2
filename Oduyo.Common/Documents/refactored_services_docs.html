<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üÜï Yeni Servisler - V2.0 Refactor Dok√ºmantasyonu</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .version-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 0.5rem;
        }

        nav {
            background: #2c3e50;
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        nav ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        nav a {
            color: white;
            text-decoration: none;
            transition: color 0.3s;
        }

        nav a:hover {
            color: #3498db;
        }

        main {
            padding: 2rem;
        }

        section {
            margin-bottom: 3rem;
        }

        h2 {
            color: #667eea;
            font-size: 1.8rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid #667eea;
        }

        h3 {
            color: #764ba2;
            font-size: 1.4rem;
            margin: 1.5rem 0 1rem;
        }

        h4 {
            color: #555;
            font-size: 1.1rem;
            margin: 1rem 0 0.5rem;
        }

        pre {
            background: #282c34;
            color: #abb2bf;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            border-left: 4px solid #667eea;
        }

        code {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .keyword { color: #c678dd; }
        .string { color: #98c379; }
        .comment { color: #5c6370; font-style: italic; }
        .method { color: #61afef; }
        .type { color: #e5c07b; }
        .number { color: #d19a66; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        th {
            background: #667eea;
            color: white;
            padding: 1rem;
            text-align: left;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .note {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .new-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
        }

        li {
            margin: 0.5rem 0;
        }

        footer {
            background: #2c3e50;
            color: white;
            text-align: center;
            padding: 1.5rem;
            margin-top: 3rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üÜï V2.0 Refactor - Yeni Servisler ve √ñzellikler</h1>
            <p>Phase 5 ile Eklenen Yeni Servisler ve G√ºncellemeler</p>
            <span class="version-badge">v2.0-refactor</span>
        </header>

        <nav>
            <ul>
                <li><a href="#overview">Genel Bakƒ±≈ü</a></li>
                <li><a href="#license-updates">License G√ºncellemeleri</a></li>
                <li><a href="#credit-usage">Credit Usage</a></li>
                <li><a href="#dealer-commission">Dealer Commission</a></li>
                <li><a href="#offer-pricing">Offer Pricing</a></li>
                <li><a href="#offer-updates">Offer G√ºncellemeleri</a></li>
                <li><a href="#payment-updates">Payment G√ºncellemeleri</a></li>
            </ul>
        </nav>

        <main>
            <section id="overview">
                <h2>üìã Genel Bakƒ±≈ü</h2>

                <div class="note">
                    <strong>üí° V2.0 Refactor:</strong> Bu dok√ºmantasyon Phase 5 ile eklenen yeni servisleri ve mevcut servislere eklenen yeni √∂zellikleri i√ßerir.
                </div>

                <h3>Yeni Servisler</h3>
                <ul>
                    <li><strong>CreditUsageService:</strong> FIFO kredi y√∂netimi ve kullanƒ±m takibi</li>
                    <li><strong>DealerCommissionService:</strong> Bayi komisyon hesaplama ve √∂deme y√∂netimi</li>
                    <li><strong>OfferPricingService:</strong> Geli≈ümi≈ü fiyatlandƒ±rma ve kampanya y√∂netimi</li>
                </ul>

                <h3>G√ºncellenen Servisler</h3>
                <ul>
                    <li><strong>LicenseService:</strong> Grace period, trial lisans, master lisans senkronizasyonu</li>
                    <li><strong>OfferService:</strong> OTP doƒürulama, kampanya freeze period</li>
                    <li><strong>PaymentService:</strong> Geli≈ümi≈ü hata y√∂netimi, provider transaction tracking</li>
                </ul>

                <h3>Yeni Teknolojiler</h3>
                <ul>
                    <li><strong>MassTransit:</strong> Asenkron mesajla≈üma (SMS, Email, PDF, Calendar)</li>
                    <li><strong>Hangfire:</strong> Background jobs (Lisans kontrol√º, teklif hatƒ±rlatma, kredi takibi)</li>
                </ul>
            </section>

            <section id="license-updates">
                <h2>üîê LicenseService G√ºncellemeleri <span class="new-badge">UPDATED</span></h2>

                <h3>1. Grace Period Desteƒüi</h3>
                <div class="success">
                    <strong>‚úì Yeni √ñzellik:</strong> Lisans s√ºresi dolduktan sonra 7 g√ºnl√ºk kullanƒ±m s√ºresi
                </div>

                <pre><code><span class="comment">// Grace period ile lisans doƒürulama</span>
<span class="keyword">var</span> result = <span class="keyword">await</span> _licenseService.ValidateLicenseAsync(licenseId);

<span class="keyword">if</span> (result.IsValid)
{
    <span class="keyword">if</span> (result.IsInGracePeriod)
    {
        Console.WriteLine(<span class="string">$"Uyarƒ±: Grace period i√ßindesiniz. {result.DaysRemaining} g√ºn kaldƒ±"</span>);
    }
    <span class="comment">// Lisans ge√ßerli, i≈üleme devam et</span>
}
<span class="keyword">else</span>
{
    Console.WriteLine(<span class="string">$"Lisans ge√ßersiz: {result.Reason}"</span>);
}</code></pre>

                <h3>2. Trial Lisans Olu≈üturma</h3>
                <pre><code><span class="comment">// 30 g√ºnl√ºk deneme lisansƒ±</span>
<span class="keyword">var</span> trialLicense = <span class="keyword">await</span> _licenseService.CreateTrialLicenseAsync(
    companyId: <span class="number">10</span>,
    productId: <span class="number">1</span>,
    packageId: <span class="number">2</span>,
    trialDays: <span class="number">30</span>,
    createdBy: currentUserId
);

<span class="comment">// Otomatik email g√∂nderilir: "Deneme lisansƒ±nƒ±z aktif"</span></code></pre>

                <h3>3. Master Lisans Senkronizasyonu</h3>
                <div class="note">
                    <strong>üí° Kullanƒ±m Senaryosu:</strong> M√º≈üteri yeni paket alƒ±rken, mevcut lisanslarƒ±yla aynƒ± biti≈ü tarihine sahip olmalƒ±.
                </div>

                <pre><code><span class="comment">// Yeni paket eklerken biti≈ü tarihini senkronize et</span>
<span class="keyword">var</span> newLicense = <span class="keyword">await</span> _licenseService.SynchronizeLicenseEndDateAsync(
    companyId: <span class="number">10</span>,
    productId: <span class="number">2</span>,
    packageId: <span class="number">5</span>,
    createdBy: currentUserId
);

<span class="comment">// Yeni lisans, firmanƒ±n master lisansƒ± ile aynƒ± EndDate'e sahip olur</span></code></pre>

                <h3>Yeni Entity Alanlarƒ±</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Alan</th>
                            <th>Tip</th>
                            <th>A√ßƒ±klama</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>IsTrial</td>
                            <td>bool</td>
                            <td>Deneme lisansƒ± mƒ±? (IsTrialPeriod yerine)</td>
                        </tr>
                        <tr>
                            <td>TrialDays</td>
                            <td>int?</td>
                            <td>Deneme s√ºresi (g√ºn)</td>
                        </tr>
                        <tr>
                            <td>GracePeriodDays</td>
                            <td>int</td>
                            <td>Grace period s√ºresi (default: 7)</td>
                        </tr>
                        <tr>
                            <td>GracePeriodStartDate</td>
                            <td>DateTime?</td>
                            <td>Grace period ba≈ülangƒ±√ß tarihi</td>
                        </tr>
                    </tbody>
                </table>

                <div class="warning">
                    <strong>‚ö†Ô∏è Breaking Change:</strong> <code>IsTrialPeriod</code> ‚Üí <code>IsTrial</code> olarak deƒüi≈ütirildi.
                </div>
            </section>

            <section id="credit-usage">
                <h2>üí≥ CreditUsageService <span class="new-badge">NEW</span></h2>

                <div class="note">
                    <strong>üí° Ne ƒ∞≈üe Yarar?</strong> M√º≈üteri kredilerinin FIFO (First In First Out) mantƒ±ƒüƒ±yla t√ºketilmesini ve takibini saƒülar.
                </div>

                <h3>FIFO Kredi T√ºketimi</h3>
                <pre><code><span class="comment">// 100 birim kredi t√ºket (en eski krediden ba≈ülayarak)</span>
<span class="keyword">var</span> success = <span class="keyword">await</span> _creditUsageService.ConsumeCreditsAsync(
    companyId: <span class="number">10</span>,
    amount: <span class="number">100</span>,
    description: <span class="string">"100 SMS g√∂nderimi"</span>
);

<span class="keyword">if</span> (!success)
{
    <span class="keyword">return</span> BadRequest(<span class="string">"Yetersiz kredi"</span>);
}

<span class="comment">// Low credit warning otomatik g√∂nderilir (< 100 kalan)</span></code></pre>

                <h3>Kredi Kontrol√º</h3>
                <pre><code><span class="comment">// ƒ∞≈ülem √∂ncesi kredi kontrol√º</span>
<span class="keyword">var</span> hasSufficientCredit = <span class="keyword">await</span> _creditUsageService.HasSufficientCreditsAsync(
    companyId: <span class="number">10</span>,
    required: <span class="number">500</span>
);

<span class="keyword">if</span> (!hasSufficientCredit)
{
    <span class="keyword">throw new</span> InsufficientCreditException(<span class="string">"Yetersiz kredi bakiyesi"</span>);
}</code></pre>

                <h3>Kredi √ñzeti</h3>
                <pre><code><span class="comment">// Firma kredi durumu √∂zeti</span>
<span class="keyword">var</span> summary = <span class="keyword">await</span> _creditUsageService.GetCreditUsageSummaryAsync(companyId);

Console.WriteLine(<span class="string">$"Toplam Kredi: {summary.TotalCredits}"</span>);
Console.WriteLine(<span class="string">$"Kullanƒ±lan: {summary.UsedCredits}"</span>);
Console.WriteLine(<span class="string">$"Kalan: {summary.RemainingCredits}"</span>);
Console.WriteLine(<span class="string">$"S√ºresi Dolmu≈ü: {summary.ExpiredCredits}"</span>);</code></pre>

                <h3>Kullanƒ±m Ge√ßmi≈üi</h3>
                <pre><code><span class="comment">// Son 30 g√ºn√ºn kredi kullanƒ±m ge√ßmi≈üi</span>
<span class="keyword">var</span> history = <span class="keyword">await</span> _creditUsageService.GetCreditUsageHistoryAsync(
    companyId: <span class="number">10</span>,
    from: DateTime.UtcNow.AddDays(-<span class="number">30</span>),
    to: DateTime.UtcNow
);

<span class="keyword">foreach</span> (<span class="keyword">var</span> usage <span class="keyword">in</span> history)
{
    Console.WriteLine(<span class="string">$"{usage.UsedAt:dd.MM.yyyy} - {usage.Amount} kredi - {usage.Description}"</span>);
}</code></pre>

                <h3>Yeni Entity: CreditUsage</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Alan</th>
                            <th>Tip</th>
                            <th>A√ßƒ±klama</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>CreditId</td>
                            <td>int</td>
                            <td>Hangi kredi paketinden kullanƒ±ldƒ±</td>
                        </tr>
                        <tr>
                            <td>CompanyId</td>
                            <td>int</td>
                            <td>Firma ID</td>
                        </tr>
                        <tr>
                            <td>Amount</td>
                            <td>int</td>
                            <td>Kullanƒ±lan miktar</td>
                        </tr>
                        <tr>
                            <td>Description</td>
                            <td>string</td>
                            <td>Ne i√ßin kullanƒ±ldƒ±</td>
                        </tr>
                        <tr>
                            <td>UsedAt</td>
                            <td>DateTime</td>
                            <td>Kullanƒ±m zamanƒ±</td>
                        </tr>
                    </tbody>
                </table>

                <div class="success">
                    <strong>‚úì Otomatik √ñzellikler:</strong>
                    <ul>
                        <li>FIFO mantƒ±ƒüƒ±yla en eski krediden t√ºketir</li>
                        <li>Kredi < 100 olunca otomatik email uyarƒ±sƒ±</li>
                        <li>S√ºresi dolmu≈ü krediler kullanƒ±lamaz</li>
                        <li>T√ºm i≈ülemler MassTransit ile asenkron</li>
                    </ul>
                </div>
            </section>

            <section id="dealer-commission">
                <h2>üíº DealerCommissionService <span class="new-badge">NEW</span></h2>

                <div class="note">
                    <strong>üí° Ne ƒ∞≈üe Yarar?</strong> Bayi komisyonlarƒ±nƒ±n otomatik hesaplanmasƒ±, onaylanmasƒ± ve √∂deme takibi.
                </div>

                <h3>Komisyon Olu≈üturma</h3>
                <pre><code><span class="comment">// √ñdeme tamamlandƒ±ktan sonra otomatik komisyon olu≈ütur</span>
<span class="keyword">var</span> commission = <span class="keyword">await</span> _dealerCommissionService.CreateCommissionAsync(
    <span class="keyword">new</span> CreateDealerCommissionDto
    {
        DealerId = <span class="number">5</span>,
        CompanyId = <span class="number">10</span>,
        OfferId = <span class="number">123</span>,
        PaymentId = <span class="number">456</span>,
        BaseAmount = <span class="number">10000</span>, <span class="comment">// √ñdeme tutarƒ±</span>
        CommissionRate = <span class="number">15</span>, <span class="comment">// %15 komisyon</span>
        Notes = <span class="string">"Teklif #123 i√ßin komisyon"</span>
    },
    createdBy: currentUserId
);

<span class="comment">// CommissionAmount otomatik hesaplanƒ±r: 10000 * 0.15 = 1500</span></code></pre>

                <h3>Komisyon Onaylama</h3>
                <pre><code><span class="comment">// Komisyonu onayla</span>
<span class="keyword">var</span> approved = <span class="keyword">await</span> _dealerCommissionService.ApproveCommissionAsync(
    commissionId: <span class="number">789</span>,
    approvedBy: managerUserId
);

<span class="comment">// Otomatik email: "Hak edi≈ü onaylandƒ±"</span></code></pre>

                <h3>Komisyon √ñdeme</h3>
                <pre><code><span class="comment">// Komisyonu √∂denmi≈ü i≈üaretle</span>
<span class="keyword">var</span> paid = <span class="keyword">await</span> _dealerCommissionService.PayCommissionAsync(
    commissionId: <span class="number">789</span>,
    paidBy: financeUserId
);

<span class="comment">// Otomatik email: "Hak edi≈ü √∂dendi - Tarih: dd.MM.yyyy"</span></code></pre>

                <h3>Bayi Komisyon Raporu</h3>
                <pre><code><span class="comment">// Bayinin toplam komisyon raporu</span>
<span class="keyword">var</span> report = <span class="keyword">await</span> _dealerCommissionService.GetDealerReportAsync(
    dealerId: <span class="number">5</span>,
    from: DateTime.UtcNow.AddMonths(-<span class="number">1</span>)
);

Console.WriteLine(<span class="string">$"Toplam Komisyon: {report.TotalCommissionAmount:C}"</span>);
Console.WriteLine(<span class="string">$"Bekleyen: {report.PendingAmount:C}"</span>);
Console.WriteLine(<span class="string">$"Onaylanan: {report.ApprovedAmount:C}"</span>);
Console.WriteLine(<span class="string">$"√ñdenen: {report.PaidAmount:C}"</span>);
Console.WriteLine(<span class="string">$"ƒ∞≈ülem Sayƒ±sƒ±: {report.CommissionCount}"</span>);</code></pre>

                <h3>Yeni Entity: DealerCommission</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Alan</th>
                            <th>Tip</th>
                            <th>A√ßƒ±klama</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>DealerId</td>
                            <td>int</td>
                            <td>Bayi ID</td>
                        </tr>
                        <tr>
                            <td>CompanyId</td>
                            <td>int</td>
                            <td>M√º≈üteri firma ID</td>
                        </tr>
                        <tr>
                            <td>OfferId</td>
                            <td>int?</td>
                            <td>ƒ∞lgili teklif</td>
                        </tr>
                        <tr>
                            <td>PaymentId</td>
                            <td>int?</td>
                            <td>ƒ∞lgili √∂deme</td>
                        </tr>
                        <tr>
                            <td>BaseAmount</td>
                            <td>decimal</td>
                            <td>Ana tutar (√∂deme)</td>
                        </tr>
                        <tr>
                            <td>CommissionRate</td>
                            <td>decimal</td>
                            <td>Komisyon oranƒ± (%)</td>
                        </tr>
                        <tr>
                            <td>CommissionAmount</td>
                            <td>decimal</td>
                            <td>Komisyon tutarƒ± (otomatik hesaplanan)</td>
                        </tr>
                        <tr>
                            <td>Status</td>
                            <td>enum</td>
                            <td>Pending, Approved, Paid, Cancelled</td>
                        </tr>
                        <tr>
                            <td>PaidAt</td>
                            <td>DateTime?</td>
                            <td>√ñdeme tarihi</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Komisyon Durumlarƒ± (CommissionStatus)</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Durum</th>
                            <th>A√ßƒ±klama</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Pending</td>
                            <td>Beklemede - Olu≈üturuldu, onay bekliyor</td>
                        </tr>
                        <tr>
                            <td>Approved</td>
                            <td>Onaylandƒ± - √ñdeme yapƒ±labilir</td>
                        </tr>
                        <tr>
                            <td>Paid</td>
                            <td>√ñdendi - Bayi √∂demesi yapƒ±ldƒ±</td>
                        </tr>
                        <tr>
                            <td>Cancelled</td>
                            <td>ƒ∞ptal - ƒ∞ade vs. nedeniyle iptal</td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <section id="offer-pricing">
                <h2>üí∞ OfferPricingService <span class="new-badge">NEW</span></h2>

                <div class="note">
                    <strong>üí° Ne ƒ∞≈üe Yarar?</strong> Teklif fiyatlandƒ±rmasƒ±nƒ± kampanya, manuel indirim ve √ßapraz satƒ±≈ü kurallarƒ±yla hesaplar.
                </div>

                <h3>Fiyat Hesaplama</h3>
                <pre><code><span class="comment">// Teklif fiyatƒ±nƒ± hesapla</span>
<span class="keyword">var</span> pricing = <span class="keyword">await</span> _offerPricingService.CalculatePricingAsync(
    <span class="keyword">new</span> OfferPricingRequest
    {
        Details = <span class="keyword">new</span>[]
        {
            <span class="keyword">new</span> OfferDetailDto { PackageId = <span class="number">1</span>, Quantity = <span class="number">1</span>, UnitPrice = <span class="number">5000</span> },
            <span class="keyword">new</span> OfferDetailDto { ModuleId = <span class="number">3</span>, Quantity = <span class="number">2</span>, UnitPrice = <span class="number">1500</span> }
        },
        CampaignId = <span class="number">10</span>,
        ManualDiscountRate = <span class="number">5</span>, <span class="comment">// %5 manuel indirim</span>
        UserId = currentUserId
    }
);

Console.WriteLine(<span class="string">$"Alt Toplam: {pricing.SubTotal:C}"</span>);
Console.WriteLine(<span class="string">$"Kampanya ƒ∞ndirimi: -{pricing.CampaignDiscount:C}"</span>);
Console.WriteLine(<span class="string">$"√áapraz Satƒ±≈ü ƒ∞ndirimi: -{pricing.CrossSellDiscount:C}"</span>);
Console.WriteLine(<span class="string">$"Manuel ƒ∞ndirim: -{pricing.ManualDiscount:C}"</span>);
Console.WriteLine(<span class="string">$"<strong>Toplam: {pricing.FinalPrice:C}</strong>"</span>);</code></pre>

                <h3>Kampanya Freeze Period</h3>
                <div class="warning">
                    <strong>‚ö†Ô∏è √ñnemli:</strong> Kampanya biti≈ü tarihinden 7 g√ºn √∂ncesi "freeze period"dur. Bu s√ºrede kampanya deƒüi≈ütirilemez ama uygulanmaya devam eder.
                </div>

                <pre><code><span class="keyword">if</span> (pricing.IsCampaignFrozen)
{
    Console.WriteLine(<span class="string">"Kampanya freeze period i√ßinde - deƒüi≈ütirilemez"</span>);
}

<span class="keyword">if</span> (pricing.IsCampaignActive)
{
    Console.WriteLine(<span class="string">"Kampanya aktif ve uygulandƒ±"</span>);
}</code></pre>

                <h3>Manuel ƒ∞ndirim Yetki Kontrol√º</h3>
                <pre><code><span class="comment">// Kullanƒ±cƒ±nƒ±n indirim yetkisi otomatik kontrol edilir</span>
<span class="keyword">try</span>
{
    <span class="keyword">var</span> pricing = <span class="keyword">await</span> _offerPricingService.CalculatePricingAsync(request);
}
<span class="keyword">catch</span> (UnauthorizedAccessException ex)
{
    <span class="comment">// Kullanƒ±cƒ±nƒ±n %X indirim yetkisi yok</span>
    Console.WriteLine(ex.Message);
}</code></pre>

                <h3>√áapraz Satƒ±≈ü Perkleri</h3>
                <div class="success">
                    <strong>‚úì Otomatik Kurallar:</strong>
                    <ul>
                        <li>Enterprise Tahsilat paketi ‚Üí Ekstre Lite mod√ºl√º bedava</li>
                        <li>Daha fazla kural eklenebilir</li>
                    </ul>
                </div>

                <pre><code><span class="comment">// Cross-sell perkleri otomatik uygulanƒ±r</span>
<span class="keyword">var</span> crossSell = <span class="keyword">await</span> _offerPricingService.CalculateCrossSellPerksAsync(details);
Console.WriteLine(<span class="string">$"√áapraz Satƒ±≈ü ƒ∞ndirimi: {crossSell:C}"</span>);</code></pre>

                <h3>OfferPriceCalculation Model</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Alan</th>
                            <th>A√ßƒ±klama</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>SubTotal</td>
                            <td>Alt toplam (indirim √∂ncesi)</td>
                        </tr>
                        <tr>
                            <td>CampaignDiscount</td>
                            <td>Kampanya indirimi</td>
                        </tr>
                        <tr>
                            <td>CrossSellDiscount</td>
                            <td>√áapraz satƒ±≈ü indirimi</td>
                        </tr>
                        <tr>
                            <td>ManualDiscount</td>
                            <td>Manuel indirim (yetki kontrol√º ile)</td>
                        </tr>
                        <tr>
                            <td>FinalPrice</td>
                            <td>Nihai fiyat</td>
                        </tr>
                        <tr>
                            <td>IsCampaignActive</td>
                            <td>Kampanya aktif mi?</td>
                        </tr>
                        <tr>
                            <td>IsCampaignFrozen</td>
                            <td>Freeze period i√ßinde mi?</td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <section id="offer-updates">
                <h2>üí∞ Offer Entity G√ºncellemeleri <span class="new-badge">UPDATED</span></h2>

                <h3>1. Fiyatlandƒ±rma Breakdown</h3>
                <div class="note">
                    <strong>üí° Deƒüi≈üiklik:</strong> Tek bir <code>Total</code> yerine detaylƒ± fiyat ayrƒ±mƒ±
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Eski</th>
                            <th>Yeni</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>SubTotal</td>
                            <td>SubTotal (aynƒ±)</td>
                        </tr>
                        <tr>
                            <td>DiscountAmount</td>
                            <td>‚ùå Kaldƒ±rƒ±ldƒ±</td>
                        </tr>
                        <tr>
                            <td>DiscountRate</td>
                            <td>‚ùå Kaldƒ±rƒ±ldƒ±</td>
                        </tr>
                        <tr>
                            <td>Total</td>
                            <td>‚ùå Kaldƒ±rƒ±ldƒ±</td>
                        </tr>
                        <tr>
                            <td>-</td>
                            <td>‚úÖ CampaignDiscount</td>
                        </tr>
                        <tr>
                            <td>-</td>
                            <td>‚úÖ ManualDiscount</td>
                        </tr>
                        <tr>
                            <td>-</td>
                            <td>‚úÖ ManualDiscountRate</td>
                        </tr>
                        <tr>
                            <td>-</td>
                            <td>‚úÖ TotalAmount</td>
                        </tr>
                    </tbody>
                </table>

                <h3>2. Kampanya Desteƒüi</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Alan</th>
                            <th>Tip</th>
                            <th>A√ßƒ±klama</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>CampaignId</td>
                            <td>int?</td>
                            <td>Uygulanan kampanya</td>
                        </tr>
                        <tr>
                            <td>IsCampaignLocked</td>
                            <td>bool</td>
                            <td>Freeze period kilidi (7 g√ºn)</td>
                        </tr>
                    </tbody>
                </table>

                <h3>3. OTP Doƒürulama</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Alan</th>
                            <th>Tip</th>
                            <th>A√ßƒ±klama</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>OtpCodeHash</td>
                            <td>string</td>
                            <td>Hash'lenmi≈ü OTP kodu</td>
                        </tr>
                        <tr>
                            <td>OtpSentAt</td>
                            <td>DateTime?</td>
                            <td>OTP g√∂nderim zamanƒ±</td>
                        </tr>
                        <tr>
                            <td>OtpVerifiedAt</td>
                            <td>DateTime?</td>
                            <td>OTP doƒürulama zamanƒ±</td>
                        </tr>
                        <tr>
                            <td>IsOtpVerified</td>
                            <td>bool</td>
                            <td>OTP doƒürulandƒ± mƒ±?</td>
                        </tr>
                    </tbody>
                </table>

                <h3>OTP Kullanƒ±mƒ±</h3>
                <pre><code><span class="comment">// 1. Teklif g√∂nderirken OTP olu≈ütur ve SMS ile g√∂nder</span>
<span class="keyword">var</span> otpSent = <span class="keyword">await</span> _offerService.SendOfferOtpAsync(offerId);

<span class="comment">// 2. M√º≈üteri OTP ile doƒürula</span>
<span class="keyword">var</span> verified = <span class="keyword">await</span> _offerService.VerifyOfferOtpAsync(
    offerId,
    otpCode: <span class="string">"123456"</span>
);

<span class="keyword">if</span> (verified)
{
    <span class="comment">// Teklif kabul edilebilir</span>
}</code></pre>
            </section>

            <section id="payment-updates">
                <h2>üí≥ Payment Entity G√ºncellemeleri <span class="new-badge">UPDATED</span></h2>

                <h3>Yeni Alanlar</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Alan</th>
                            <th>Tip</th>
                            <th>A√ßƒ±klama</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>ProviderTransactionId</td>
                            <td>string</td>
                            <td>Sanal POS provider'dan gelen TXN ID</td>
                        </tr>
                        <tr>
                            <td>PaymentDate</td>
                            <td>DateTime</td>
                            <td>√ñdeme ba≈ülatma tarihi</td>
                        </tr>
                        <tr>
                            <td>CompletedAt</td>
                            <td>DateTime?</td>
                            <td>√ñdeme tamamlanma zamanƒ±</td>
                        </tr>
                        <tr>
                            <td>FailureReason</td>
                            <td>string</td>
                            <td>Ba≈üarƒ±sƒ±zlƒ±k nedeni</td>
                        </tr>
                        <tr>
                            <td>FailureCode</td>
                            <td>string</td>
                            <td>Hata kodu (provider'dan)</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Geli≈ümi≈ü Hata Y√∂netimi</h3>
                <pre><code><span class="comment">// √ñdeme ba≈üarƒ±sƒ±z olduƒüunda detaylƒ± hata kaydet</span>
<span class="keyword">await</span> _paymentService.FailPaymentAsync(
    paymentId,
    failureReason: <span class="string">"Yetersiz bakiye"</span>,
    failureCode: <span class="string">"INSUFFICIENT_FUNDS"</span>
);

<span class="comment">// Payment.FailureReason ve FailureCode kaydedilir</span></code></pre>

                <h3>Provider Transaction Tracking</h3>
                <pre><code><span class="comment">// √ñdeme tamamlandƒ±ƒüƒ±nda provider TXN ID'yi kaydet</span>
<span class="keyword">await</span> _paymentService.CompletePaymentAsync(
    paymentId,
    providerTxnId: <span class="string">"IBANK_TXN_987654321"</span>,
    completedBy: currentUserId
);

<span class="comment">// Daha sonra provider TXN ile √∂deme sorgulanabilir</span></code></pre>
            </section>

            <section>
                <h2>üîÑ MassTransit Entegrasyonu</h2>

                <div class="success">
                    <strong>‚úì Asenkron ƒ∞≈ülemler:</strong> T√ºm email, SMS, PDF ve calendar i≈ülemleri artƒ±k asenkron yapƒ±lƒ±yor.
                </div>

                <h3>Otomatik Tetiklenen ƒ∞≈ülemler</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Olay</th>
                            <th>Mesaj</th>
                            <th>Sonu√ß</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Trial Lisans Olu≈üturma</td>
                            <td>SendEmailMessage</td>
                            <td>Email: "Deneme lisansƒ±nƒ±z aktif"</td>
                        </tr>
                        <tr>
                            <td>Kredi < 100</td>
                            <td>SendEmailMessage</td>
                            <td>Email: "Kredi azaldƒ±"</td>
                        </tr>
                        <tr>
                            <td>Komisyon Onaylandƒ±</td>
                            <td>SendEmailMessage</td>
                            <td>Email: "Hak edi≈ü onaylandƒ±"</td>
                        </tr>
                        <tr>
                            <td>Komisyon √ñdendi</td>
                            <td>SendEmailMessage</td>
                            <td>Email: "Hak edi≈ü √∂dendi"</td>
                        </tr>
                        <tr>
                            <td>Teklif PDF ƒ∞steƒüi</td>
                            <td>GenerateOfferPdfMessage</td>
                            <td>PDF olu≈ütur ve email ekinde g√∂nder</td>
                        </tr>
                        <tr>
                            <td>Demo Olu≈üturma</td>
                            <td>SyncCalendarMessage</td>
                            <td>Google Calendar'a ekle</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Message √ñrnekleri</h3>
                <pre><code><span class="comment">// Email g√∂nderme (template ile)</span>
<span class="keyword">await</span> _bus.Publish(<span class="keyword">new</span> SendEmailMessage
{
    To = <span class="string">"user@example.com"</span>,
    Subject = <span class="string">"Lisansƒ±nƒ±z Dolmak √úzere"</span>,
    TemplateId = <span class="string">"license-expiring"</span>,
    TemplateData = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;
    {
        [<span class="string">"DaysRemaining"</span>] = <span class="string">"7"</span>
    }
});

<span class="comment">// SMS g√∂nderme</span>
<span class="keyword">await</span> _bus.Publish(<span class="keyword">new</span> SendSmsMessage
{
    Phone = <span class="string">"5551234567"</span>,
    Message = <span class="string">"Teklif OTP kodunuz: 123456"</span>,
    EntityType = <span class="string">"Offer"</span>,
    RelatedEntityId = offerId
});</code></pre>
            </section>

            <section>
                <h2>‚è∞ Hangfire Background Jobs</h2>

                <h3>Zamanlanmƒ±≈ü Job'lar</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Job</th>
                            <th>√áalƒ±≈üma Sƒ±klƒ±ƒüƒ±</th>
                            <th>G√∂rev</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>OfferExpiryJob</td>
                            <td>Saatlik</td>
                            <td>S√ºresi dolan teklifleri Expired durumuna alƒ±r</td>
                        </tr>
                        <tr>
                            <td>OfferReminderJob</td>
                            <td>G√ºnl√ºk 09:00</td>
                            <td>5 g√ºn i√ßinde dolacak teklifler i√ßin hatƒ±rlatma</td>
                        </tr>
                        <tr>
                            <td>LicenseMonitorJob</td>
                            <td>G√ºnl√ºk 02:00</td>
                            <td>Grace period aktivasyon, s√ºresi dolan lisanslarƒ± deaktive et</td>
                        </tr>
                        <tr>
                            <td>CreditExpiryJob</td>
                            <td>G√ºnl√ºk 03:00</td>
                            <td>S√ºresi dolan krediler i√ßin bildirim, 7 g√ºn √∂nceden uyarƒ±</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Dashboard</h3>
                <pre><code><span class="comment">// Hangfire Dashboard</span>
<span class="comment">// URL: https://yourdomain.com/hangfire</span>

<span class="comment">// Recurring Jobs sekmesinde t√ºm job'larƒ± g√∂rebilirsiniz</span>
<span class="comment">// "Trigger Now" ile manuel tetikleyebilirsiniz</span></code></pre>
            </section>

            <section>
                <h2>üì¶ Migration Checklist</h2>

                <div class="warning">
                    <strong>‚ö†Ô∏è √ñnemli:</strong> Production'a ge√ßmeden √∂nce t√ºm adƒ±mlarƒ± tamamlayƒ±n!
                </div>

                <h3>Database Deƒüi≈üiklikleri</h3>
                <ul>
                    <li>‚úÖ License: IsTrial, TrialDays, GracePeriodDays, GracePeriodStartDate</li>
                    <li>‚úÖ Offer: CampaignDiscount, ManualDiscount, TotalAmount, CampaignId, IsCampaignLocked, OTP alanlarƒ±</li>
                    <li>‚úÖ Payment: ProviderTransactionId, PaymentDate, CompletedAt, FailureReason, FailureCode</li>
                    <li>‚úÖ Company: ContactName, Phone, Email, Address, ProductInterests</li>
                    <li>‚úÖ Demo: DemoEndTime, ReferenceCode, ChannelId, LocationType, CalendarEventId</li>
                    <li>‚úÖ Campaign: IsPublic, computed properties (IsCurrentlyActive, IsWithinFreezePeriod)</li>
                    <li>‚úÖ YENƒ∞: DealerCommission tablosu</li>
                    <li>‚úÖ YENƒ∞: DiscountRate tablosu</li>
                    <li>‚úÖ YENƒ∞: CreditUsage tablosu</li>
                </ul>

                <h3>Servis Kayƒ±tlarƒ± (Program.cs)</h3>
                <pre><code><span class="comment">// Yeni servisler</span>
builder.Services.AddScoped&lt;ICreditUsageService, CreditUsageService&gt;();
builder.Services.AddScoped&lt;IDealerCommissionService, DealerCommissionService&gt;();
builder.Services.AddScoped&lt;IOfferPricingService, OfferPricingService&gt;();

<span class="comment">// MassTransit</span>
builder.Services.AddMassTransit(x => { <span class="comment">/* config */</span> });

<span class="comment">// Hangfire</span>
builder.Services.AddHangfire(config => { <span class="comment">/* config */</span> });
builder.Services.AddHangfireServer();</code></pre>
            </section>

            <section>
                <h2>üìö Kaynaklar</h2>

                <ul>
                    <li><strong>REFACTOR_SUMMARY.md</strong> - T√ºm deƒüi≈üikliklerin √∂zeti</li>
                    <li><strong>PHASE_6_IMPLEMENTATION_GUIDE.md</strong> - Adƒ±m adƒ±m uygulama kƒ±lavuzu</li>
                    <li><strong>oduyo_refactor_plan_rev1.md</strong> - Orijinal refactor planƒ±</li>
                </ul>

                <div class="note">
                    <strong>üí° Sorularƒ±nƒ±z i√ßin:</strong> PHASE_6_IMPLEMENTATION_GUIDE.md dosyasƒ±na bakƒ±n veya teknik liderle g√∂r√º≈ü√ºn.
                </div>
            </section>
        </main>

        <footer>
            <p>&copy; 2025 √ñd√ºyo CRM - V2.0 Refactor Dok√ºmantasyonu</p>
            <p><strong>Versiyon:</strong> 2.0-refactor | <strong>G√ºncelleme Tarihi:</strong> 2025-10-08</p>
        </footer>
    </div>
</body>
</html>
